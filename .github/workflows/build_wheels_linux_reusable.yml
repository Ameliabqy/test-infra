name: Build Linux Wheels

on:
  workflow_call:
    inputs:
      repository:
        description: 'name of the domain library calling this reusable workflow.'
        required: true
        type: string
      image:
        description: 'docker image container for running the reusable workflow.'
        required: true
        type: string
      python_version:
        description: 'python version to use for building wheels binary'
        required: true
        type: string

jobs:
  wheels:
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: ${{ inputs.python_version }}
      PACKAGE_TYPE: wheel
      REPOSITORY: ${{ inputs.repository }}
    container:
      image: ${{ inputs.image }}
    steps:
    - uses: actions/checkout@v2
    - name: Install pytorch-pkg-helpers
      run: |
        python3 -m pip install pytorch-pkg-helpers==0.1.0
    - name: Create environemnt variables from pytorch-pkg-helpers
      run: |
        BUILD_ENV_FILE="${RUNNER_TEMP}/build_env_${GITHUB_RUN_ID}"
        python3 -m pytorch_pkg_helpers > "${BUILD_ENV_FILE}"
        echo "BUILD_ENV_FILE=${BUILD_ENV_FILE}" >> "${GITHUB_ENV}"
    - name: Run pre-build script
      run: ./packaging/pre_build_script.sh
    - name: Build clean
      run: python setup.py clean
    - name: Build wheels
      run: python setup.py bdist_wheel
    - name: Run post-build script
      run: ./packaging/post_build_script.sh
